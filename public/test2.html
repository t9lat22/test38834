<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T9 OS Browser</title>
  
  <!-- Ultraviolet setup -->
  <script src="/uv/uv.bundle.js" defer></script>
  <script src="/uv/uv.config.js" defer></script>
  <script src="/baremux/server.js" defer></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, sans-serif;
    }

    :root {
      --primary: #0078ff;
      --primary-dark: #005dc1;
      --dark-bg: #0f0f0f;
      --card-bg: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #aaaaaa;
    }

    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--dark-bg);
      color: var(--text-primary);
      overflow: hidden;
    }

    .tabbar {
      display: flex;
      align-items: center;
      background: #111;
      height: 40px;
      padding: 0 8px;
      border-bottom: 1px solid #333;
      overflow-x: auto;
      flex-shrink: 0;
    }

    .tab {
      display: flex;
      align-items: center;
      background: #222;
      padding: 4px 12px;
      margin-right: 4px;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      max-width: 180px;
      min-width: 120px;
      border: 1px solid transparent;
      flex-shrink: 0;
    }

    .tab.active {
      background: #333;
      border-color: var(--primary);
      color: var(--text-primary);
    }

    .tab-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .close-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 14px;
      cursor: pointer;
      margin-left: 6px;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .close-btn:hover {
      color: #ff375f;
    }

    .new-tab-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 18px;
      cursor: pointer;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-left: 4px;
    }

    .address-bar {
      display: flex;
      align-items: center;
      background: #151515;
      height: 50px;
      padding: 0 12px;
      border-bottom: 1px solid #333;
      gap: 8px;
      flex-shrink: 0;
    }

    .nav-button {
      background: #2a2a2a;
      border: none;
      color: var(--text-primary);
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .nav-button:hover {
      background: var(--primary);
    }

    .nav-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .nav-button:disabled:hover {
      background: #2a2a2a;
    }

    .url-container {
      flex: 1;
      display: flex;
      align-items: center;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 0 12px;
      height: 34px;
      min-width: 0;
    }

    #urlInput {
      flex: 1;
      height: 100%;
      border: none;
      outline: none;
      font-size: 14px;
      background: transparent;
      color: var(--text-primary);
      min-width: 0;
    }

    #urlInput::placeholder {
      color: #666;
    }

    #searchButton {
      background: var(--primary);
      border: none;
      color: white;
      padding: 0 16px;
      border-radius: 6px;
      cursor: pointer;
      height: 32px;
      font-size: 13px;
      font-weight: 600;
      flex-shrink: 0;
    }

    #searchButton:hover {
      background: var(--primary-dark);
    }

    .content-area {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    .iframeWindow {
      width: 100%;
      height: 100%;
      border: none;
      background: var(--dark-bg);
    }

    .home {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--dark-bg);
      padding: 20px;
      text-align: center;
    }

    .home h1 {
      font-size: 3em;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--primary);
    }

    .search-container {
      display: flex;
      width: 100%;
      max-width: 500px;
      margin-bottom: 30px;
    }

    #centerSearch {
      flex: 1;
      height: 44px;
      font-size: 16px;
      border-radius: 8px 0 0 8px;
      border: 1px solid #333;
      border-right: none;
      outline: none;
      padding: 0 16px;
      background: #1a1a1a;
      color: var(--text-primary);
    }

    #centerSearch:focus {
      border-color: var(--primary);
    }

    #centerGo {
      height: 44px;
      font-size: 16px;
      border: none;
      border-radius: 0 8px 8px 0;
      padding: 0 20px;
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-weight: 600;
    }

    #centerGo:hover {
      background: var(--primary-dark);
    }

    .quick-links {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      width: 100%;
      max-width: 500px;
    }

    .quick-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .quick-link:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .quick-link-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
      font-size: 16px;
      background: var(--primary);
      color: white;
    }

    .quick-link-title {
      font-size: 12px;
      color: var(--text-primary);
    }

    .loading-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 2px;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s;
      z-index: 10;
    }

    /* Performance optimizations */
    .tab, .nav-button, .quick-link {
      will-change: transform;
      transform: translateZ(0);
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .quick-links {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .home h1 {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>

  <div class="tabbar" id="tabbar"></div>

  <div class="address-bar">
    <button class="nav-button" id="backBtn" title="Back">←</button>
    <button class="nav-button" id="forwardBtn" title="Forward">→</button>
    <button class="nav-button" id="refreshBtn" title="Refresh">↻</button>
    
    <div class="url-container">
      <input type="text" id="urlInput" placeholder="Search or enter website name...">
    </div>
    
    <button id="searchButton">Go</button>
  </div>

  <div class="loading-bar" id="loadingBar"></div>

  <div class="content-area">
    <iframe id="iframeWindow" class="iframeWindow" style="display:none;"></iframe>

    <div class="home" id="homePage">
      <h1>T9 OS</h1>
      
      <div class="search-container">
        <input type="text" id="centerSearch" placeholder="Search Google or enter a URL...">
        <button id="centerGo">Go</button>
      </div>

      <div class="quick-links">
        <div class="quick-link" data-url="https://www.google.com">
          <div class="quick-link-icon">G</div>
          <div class="quick-link-title">Google</div>
        </div>
        <div class="quick-link" data-url="https://www.youtube.com">
          <div class="quick-link-icon">Y</div>
          <div class="quick-link-title">YouTube</div>
        </div>
        <div class="quick-link" data-url="https://www.github.com">
          <div class="quick-link-icon">G</div>
          <div class="quick-link-title">GitHub</div>
        </div>
        <div class="quick-link" data-url="https://www.reddit.com">
          <div class="quick-link-icon">R</div>
          <div class="quick-link-title">Reddit</div>
        </div>
        <div class="quick-link" data-url="https://www.twitter.com">
          <div class="quick-link-icon">T</div>
          <div class="quick-link-title">Twitter</div>
        </div>
        <div class="quick-link" data-url="https://www.netflix.com">
          <div class="quick-link-icon">N</div>
          <div class="quick-link-title">Netflix</div>
        </div>
        <div class="quick-link" data-url="https://www.amazon.com">
          <div class="quick-link-icon">A</div>
          <div class="quick-link-title">Amazon</div>
        </div>
        <div class="quick-link" data-url="https://www.wikipedia.org">
          <div class="quick-link-icon">W</div>
          <div class="quick-link-title">Wikipedia</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Ultra-fast browser implementation
    const googleSearch = "https://www.google.com/search?q=";

    // DOM cache - single query at startup
    const elements = {
      tabbar: document.getElementById("tabbar"),
      iframe: document.getElementById("iframeWindow"),
      input: document.getElementById("urlInput"),
      searchBtn: document.getElementById("searchButton"),
      homePage: document.getElementById("homePage"),
      centerInput: document.getElementById("centerSearch"),
      centerGo: document.getElementById("centerGo"),
      loadingBar: document.getElementById("loadingBar"),
      backBtn: document.getElementById("backBtn"),
      forwardBtn: document.getElementById("forwardBtn"),
      refreshBtn: document.getElementById("refreshBtn")
    };

    // State management with minimal data
    let state = {
      tabs: [],
      currentTabId: null,
      historyStack: [],
      historyIndex: -1,
      // Lazy load other data when needed
      dataLoaded: false
    };

    // Initialize with minimal setup
    function init() {
      setupEventListeners();
      setupQuickLinks();
      addTab(); // Start with one tab
      
      // Delay heavy operations
      setTimeout(loadPersistedData, 100);
    }

    // Efficient event listener setup
    function setupEventListeners() {
      // Navigation
      elements.searchBtn.onclick = () => navigate(elements.input.value);
      elements.input.onkeydown = e => e.key === "Enter" && navigate(elements.input.value);
      elements.centerGo.onclick = () => navigate(elements.centerInput.value);
      elements.centerInput.onkeydown = e => e.key === "Enter" && navigate(elements.centerInput.value);
      
      // History
      elements.backBtn.onclick = goBack;
      elements.forwardBtn.onclick = goForward;
      elements.refreshBtn.onclick = refreshPage;
      
      // Iframe events
      elements.iframe.onload = onIframeLoad;
    }

    function setupQuickLinks() {
      const links = document.querySelectorAll('.quick-link');
      links.forEach(link => {
        link.onclick = () => navigate(link.dataset.url);
      });
    }

    // Optimized tab management
    function renderTabs() {
      const fragment = document.createDocumentFragment();
      
      state.tabs.forEach(tab => {
        const div = document.createElement("div");
        div.className = `tab${tab.id === state.currentTabId ? " active" : ""}`;
        div.innerHTML = `
          <span class="tab-title">${tab.title}</span>
          <button class="close-btn" data-id="${tab.id}">×</button>
        `;
        div.onclick = () => switchTab(tab.id);
        fragment.appendChild(div);
      });
      
      const addBtn = document.createElement("button");
      addBtn.className = "new-tab-btn";
      addBtn.textContent = "+";
      addBtn.onclick = addTab;
      fragment.appendChild(addBtn);
      
      elements.tabbar.innerHTML = "";
      elements.tabbar.appendChild(fragment);
      
      // Delegate close button events
      elements.tabbar.onclick = e => {
        if (e.target.classList.contains('close-btn')) {
          closeTab(parseInt(e.target.dataset.id));
        }
      };
    }

    function addTab() {
      const id = Date.now();
      state.tabs.push({ 
        id, 
        title: "New Tab", 
        url: ""
      });
      switchTab(id);
      renderTabs();
      showHome(true);
    }

    function closeTab(id) {
      const idx = state.tabs.findIndex(t => t.id === id);
      if (idx > -1) state.tabs.splice(idx, 1);
      if (state.tabs.length === 0) addTab();
      else if (state.currentTabId === id) switchTab(state.tabs[Math.max(idx - 1, 0)].id);
      renderTabs();
    }

    function switchTab(id) {
      state.currentTabId = id;
      renderTabs();
      const tab = state.tabs.find(t => t.id === id);
      if (tab && tab.url) {
        loadURL(tab.url, false);
      } else {
        showHome(true);
      }
    }

    // Optimized navigation
    function navigate(query) {
      if (!query) return;
      
      const isURL = query.includes(".") && !query.includes(" ");
      let fullURL;
      
      if (isURL) {
        fullURL = /^https?:\/\//i.test(query) ? query : "https://" + query;
      } else {
        fullURL = googleSearch + encodeURIComponent(query);
      }

      const tab = state.tabs.find(t => t.id === state.currentTabId);
      if (tab) {
        tab.url = __uv$config.prefix + __uv$config.encodeUrl(fullURL);
        tab.title = isURL ? new URL(fullURL).hostname : query;
      }

      loadURL(tab.url, true);
      renderTabs();
    }

    function loadURL(url, addToHistory = true) {
      elements.iframe.style.display = "block";
      elements.homePage.style.display = "none";
      
      if (elements.iframe.src !== url) {
        elements.iframe.src = url;
        startLoading();
      }
      
      elements.input.value = url.replace(__uv$config.prefix, "");
      
      if (addToHistory) {
        state.historyStack = state.historyStack.slice(0, state.historyIndex + 1);
        state.historyStack.push(url);
        state.historyIndex = state.historyStack.length - 1;
      }
      
      updateNavigationButtons();
    }

    function goBack() {
      if (state.historyIndex > 0) {
        state.historyIndex--;
        loadURL(state.historyStack[state.historyIndex], false);
      }
    }

    function goForward() {
      if (state.historyIndex < state.historyStack.length - 1) {
        state.historyIndex++;
        loadURL(state.historyStack[state.historyIndex], false);
      }
    }

    function refreshPage() {
      if (state.historyIndex >= 0) {
        loadURL(state.historyStack[state.historyIndex], false);
      }
    }

    function updateNavigationButtons() {
      elements.backBtn.disabled = state.historyIndex <= 0;
      elements.forwardBtn.disabled = state.historyIndex >= state.historyStack.length - 1;
    }

    // Optimized loading indicator
    function startLoading() {
      elements.loadingBar.style.width = '30%';
      setTimeout(() => {
        if (elements.loadingBar.style.width === '30%') {
          elements.loadingBar.style.width = '70%';
        }
      }, 300);
    }

    function finishLoading() {
      elements.loadingBar.style.width = '100%';
      setTimeout(() => {
        elements.loadingBar.style.width = '0%';
      }, 200);
    }

    function onIframeLoad() {
      finishLoading();
      
      // Update tab title efficiently
      try {
        const tab = state.tabs.find(t => t.id === state.currentTabId);
        if (tab && elements.iframe.contentDocument && elements.iframe.contentDocument.title) {
          tab.title = elements.iframe.contentDocument.title.substring(0, 20) + (elements.iframe.contentDocument.title.length > 20 ? '...' : '');
          renderTabs();
        }
      } catch (e) {
        // Cross-origin restriction, ignore
      }
    }

    function showHome(show) {
      elements.homePage.style.display = show ? "flex" : "none";
      elements.iframe.style.display = show ? "none" : "block";
      
      if (show) {
        elements.input.value = '';
      }
    }

    // Lazy data loading
    function loadPersistedData() {
      if (state.dataLoaded) return;
      
      try {
        const savedTabs = localStorage.getItem('t9_tabs');
        if (savedTabs) {
          state.tabs = JSON.parse(savedTabs);
          if (state.tabs.length > 0) {
            state.currentTabId = state.tabs[0].id;
            renderTabs();
            
            // Restore last URL if available
            const lastTab = state.tabs.find(t => t.url);
            if (lastTab) {
              loadURL(lastTab.url, false);
            } else {
              showHome(true);
            }
          }
        }
        
        const savedHistory = localStorage.getItem('t9_history');
        if (savedHistory) {
          state.historyStack = JSON.parse(savedHistory);
          state.historyIndex = state.historyStack.length - 1;
          updateNavigationButtons();
        }
      } catch (e) {
        console.error("Error loading data:", e);
      }
      
      state.dataLoaded = true;
    }

    // Efficient data saving with debouncing
    let saveTimeout;
    function saveData() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        try {
          localStorage.setItem('t9_tabs', JSON.stringify(state.tabs));
          localStorage.setItem('t9_history', JSON.stringify(state.historyStack));
        } catch (e) {
          console.error("Error saving data:", e);
        }
      }, 500);
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', init);
    
    // Save data periodically and on unload
    setInterval(saveData, 10000);
    window.addEventListener('beforeunload', saveData);
    
    // Delay service worker registration
    window.addEventListener("load", () => {
      setTimeout(() => {
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("/uv/sw.js", { scope: __uv$config.prefix });
        }
      }, 500);
    });
  </script>
</body>
</html>
